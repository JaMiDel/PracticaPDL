package Analizador;
import java.util.HashMap;
import java.util.Map;

import Objetos.Reader;
import Objetos.Token;
import Objetos.Writter;

public class AnalizadorLexico{
    private char caracterActual;
    private String stringActual;
    private int numeroActual;
    private Reader fileReader;
    private Writter tokenWritter;
    private int tamPalRes = 11;
    private ErrorControl errores;
    private Map<String, Integer> palabrasReservadas;
    private Map<String, Integer> simbolos;
	private TablaSimbolosControl control;
   
    public AnalizadorLexico(Reader file_reader, Writter token_Writter, TablaSimbolosControl stHandler, ErrorControl errControl) {
        this.inicializaTabla();
        this.setFileReader(file_reader);
        this.tokenWritter = token_Writter;
        this.control=stHandler;
        this.errores=errControl;
        this.readChar();
    }

    public Token getToken() {
    	
        Token token = new Token("NULL");
        this.stringActual = "";
        this.numeroActual = 0;
        if (!this.isDel(this.caracterActual)) {
            if (this.caracterActual == '/') {
                this.readChar();
                if (this.caracterActual == '/') {
                 this.readChar();
                    while (this.caracterActual != '\n') {
                        this.readChar();
                    }
                    return this.getToken();
                }
                if(this.caracterActual == '*'){
                	while(this.caracterActual != '/'){
                		while(this.caracterActual != '*') {
                			this.readChar();
                		}
                		this.readChar();
					}
                	this.readChar();
                	return this.getToken();
                }
               
                this.errores.write(String.format("Linea %d: Analizador Lexico - Caracter(es) \"%s\" no esperado(s)", getFileReader().getCurrentLine(),this.caracterActual));
            }
            else if (this.isNo(this.caracterActual)) {
                this.calculateValue();
                this.readChar();
                while (this.isNo(this.caracterActual) && this.numeroActual <= 32767) {
                    this.calculateValue();
                    this.readChar();
                }
                if (this.numeroActual <= 32767) {
                    return this.generate_token("NUM", this.numeroActual);
                }
                this.errores.write(String.format("Linea %d: Analizador Lexico - NUM ( %d ) fuera de rango", getFileReader().getCurrentLine(),this.numeroActual));
            }
            else if (this.caracterActual == '\"') {
                this.readChar();
                while (this.caracterActual != '\"' && this.caracterActual != '\n' && this.caracterActual != '\0') {
                    this.concValue();
                    this.readChar();
                }
                if (this.caracterActual == '\"') {
                    this.readChar();
                    return this.generate_token("CAD", this.stringActual);
                }
                this.errores.write(String.format("Linea %d: Analizador Lexico - CAD no valida", getFileReader().getCurrentLine()));
            }
            else if (this.isLet(this.caracterActual)) {
                this.concValue();
                this.readChar();
                while (this.isLet(this.caracterActual) || this.isNo(this.caracterActual) || this.caracterActual == '_') {
                    this.concValue();
                    this.readChar();
                }
                Integer idPalRes = this.palabrasReservadas.get(this.stringActual);
                if (idPalRes != null) {
                    return this.generate_token("PAL_RES", idPalRes);
                }else{
                	EntradaTS entrada = this.control.buscarEntradaPorLexema(this.stringActual);
                	
    				if (entrada == null){
    					entrada = this.control.insertarEntrada(this.stringActual);
    				
    				}
    				
                	return this.generate_token("ID", entrada.getId());
                }
                
            }
            else {
            	if (this.caracterActual == '>') {
                    this.concValue();
                    this.readChar();
                    return this.generate_token("OPERADOR", this.simbolos.get(this.stringActual));
                } 
                if (this.caracterActual == '=') {
                    this.concValue();
                    this.readChar();
                    return this.generate_token("OPERADOR", this.simbolos.get(this.stringActual));
                }
                if (this.caracterActual == '+') {
                    this.concValue();
                    this.readChar();
                    return this.generate_token("OPERADOR", this.simbolos.get(this.stringActual));
                }
                if (this.caracterActual == '|') {
                    this.concValue();
                    this.readChar();
                    if (this.caracterActual == '=') {
                        this.concValue();
                        this.readChar();
                        return this.generate_token("OPERADOR", this.simbolos.get(this.stringActual));             
                    }
                    this.errores.write(String.format("Linea %d: Analizador Lexico - Formato del operador OR_asignacion incorrecto", getFileReader().getCurrentLine()));
                }
                
                if (this.caracterActual == '&') {
                    this.concValue();
                    this.readChar();
                    if (this.caracterActual == '&') {
                        this.concValue();
                        this.readChar();
                        return this.generate_token("OPERADOR", this.simbolos.get(this.stringActual));
                    }
                    this.errores.write(String.format("Linea %d: Analizador Lexico - Formato del operador AND incorrecto", getFileReader().getCurrentLine()));

                }
                else {

                    if (this.isSymbol(this.caracterActual)) {
                        this.concValue();
                        this.readChar();
                        return this.generate_token("CARACTER", this.stringActual);
                    }
                    this.errores.write(String.format("Linea %d: Analizador Lexico - Caracter ( %s ) no soportado", getFileReader().getCurrentLine(),this.caracterActual));
                    this.readChar();
                }
            }
            return token;
        }
        if (this.caracterActual == '\t'){
        	 this.readChar();
        } 
        if (this.caracterActual == '\n') {
            this.readChar();
            return this.generate_token("EOL", null);
        }
        if (this.caracterActual == '\0') {
            token = this.generate_token("EOF", null);
            this.getFileReader().close();
            return token;
        }
        this.readChar();
        return this.getToken();

       
    }

    private void readChar() {
        this.caracterActual = this.getFileReader().read();
    }   

    private void concValue() {
        this.stringActual = String.valueOf(this.stringActual) + this.caracterActual;
    }

    private void calculateValue() {
        this.concValue();
        this.numeroActual = this.numeroActual * 10 + (this.caracterActual - '0');
    }

    private Token generate_token(String id, Object attr) {
        Token token = new Token(id, attr);
        if (id.equals("CAD")) { 	
            token.setValue(this.stringActual);
        }
        if(id.equals("NUM")){
        	token.setValue(this.numeroActual);
        }
        this.tokenWritter.write(token.toString());
        return token;
    } 

    private boolean isDel(char c) {
    	if(c == ' ' || c == '\r' || c == '\n' || c == '\0'){
    		return true;
    	}
        return false;
    }

    private boolean isNo(char c) {
    	if(c >= '0' && c <= '9'){
    		return true;
    	}
        return false;
    }

    private boolean isLet(char c) {
    	if((c >= 'A' && c <= 'Z') || (c >= 'a' && c <= 'z')){
    		return true;
    	}
        return false;
    }

    private boolean isSymbol(char c) {
    	if(c == '(' || c == ')' || c == ',' || c == '.' || c == '{' || c == '}' || c == ';'){
    		return true;
    	}
        return false;
    }

	private boolean buscarLexema(Map<String, Integer> palRes2, String id) {
		boolean result = false;
		if (palRes2.containsKey(id)) {
			result = true;
		}
		return result;
	}
	
    // REVISADO
    private void inicializaTabla() {
        this.palabrasReservadas = new HashMap<String, Integer>();
        this.palabrasReservadas.put("var", 0);
        this.palabrasReservadas.put("int", 1);
        this.palabrasReservadas.put("chars", 2);
        this.palabrasReservadas.put("bool", 3);
        this.palabrasReservadas.put("while", 4);
        this.palabrasReservadas.put("function", 5);
        this.palabrasReservadas.put("return", 6);
        this.palabrasReservadas.put("true", 7);     
        this.palabrasReservadas.put("false", 8);
        this.palabrasReservadas.put("write", 9);
        this.palabrasReservadas.put("prompt", 10);
        this.simbolos = new HashMap<String, Integer>();
        this.simbolos.put("%", 0);
        this.simbolos.put("=", 1);
        this.simbolos.put(">", 3);
        this.simbolos.put("%=", 2);
        this.simbolos.put("||", 4);
    }
    // REVISADO
	public Reader getFileReader() {
		return fileReader;
	}
	// REVISADO
	public void setFileReader(Reader fileReader) {
		this.fileReader = fileReader;
	}
	// REVISADO
	public void write(String s){
		this.tokenWritter.write(s);
	}
}
